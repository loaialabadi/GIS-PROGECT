<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>شهادة تتبع زمني لمنشأ</title>
    <style>
        body { font-family: 'Arial', sans-serif; background: #eee; margin: 0; padding: 20px; }
        .container { display: flex; max-width: 1200px; margin: auto; background: #fff; border: 2px solid black; padding: 15px; box-sizing: border-box; }
        .right-column { flex: 1; border-left: 2px solid black; padding-left: 15px; display: flex; flex-direction: column; }
        .logos { display: flex; justify-content: space-between; gap: 40px; margin-bottom: 20px; }
        .logo-box { text-align: center; }
        .logo-title { font-weight: bold; margin-top: 5px; font-size: 14px; }
        .logo { width: 60px; height: 60px; object-fit: contain; border: 1px solid black; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
        table, th, td { border: 1px solid black; }
        td { padding: 6px; font-size: 14px; }
        .left-columns { flex: 2; display: flex; flex-direction: column; padding-right: 15px; }
        .certificate-title { font-size: 24px; font-weight: bold; text-align: center; background: #fde5a6; padding: 12px; border: 1px solid black; margin-bottom: 35px; }
        .photos-container { display: grid; grid-template-columns: repeat(2, 1fr); grid-gap: 15px; margin-bottom: 15px; height: 800px; }
        .photo-box { height: 390px; border: 2px dashed #aaa; border-radius: 8px; background: #f9f9f9; display: flex; justify-content: center; align-items: center; color: #888; font-size: 14px; cursor: pointer; overflow: hidden; position: relative; }
        .photo-label { position: absolute; top: -25px; left: 50%; transform: translateX(-50%); background-color: rgba(0, 0, 0, 0.7); color: white; padding: 3px 10px; border-radius: 5px; font-weight: bold; white-space: nowrap; z-index: 10; pointer-events: none; }
        .photo-box img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .footer-text { max-width: 1200px; margin: 50px auto 0; font-size: 13px; text-align: center; border-top: 1px solid black; padding-top: 10px; color: #555; line-height: 1.3; }
        @media print {
            body { background: white; margin: 0; padding: 0; }
            #printBtn, #saveBtn { display: none !important; }
            @page { size: A3 landscape; margin: 1cm; }
            html, body { width: auto; height: auto; }
            .container { box-shadow: none !important; border: none !important; padding: 0 !important; margin: 0 auto !important; max-width: 100%; }
        }
    </style>
</head>
<body>
    <button onclick="printCertificate()" id="printBtn" style="position: fixed; top: 20px; left: 20px; z-index: 9999; padding: 10px 20px; background-color: #0d6efd; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px;">🖨️ طباعة الشهادة</button>
    <button onclick="saveCertificate()" id="saveBtn" style="position: fixed; top: 20px; left: 180px; z-index: 9999; padding: 10px 20px; background-color: #198754; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 16px;">💾 حفظ كصورة</button>

    <div class="container">
        <!-- العمود الأيمن -->
        <div class="right-column">
            <!-- اللوجوهات -->
            <div class="logos">
                <div class="logo-box">
                    <img src="{{ asset('images/logo2.png') }}" class="logo" alt="Logo 2">
                    <div class="logo-title">ديوان عام محافظة قنا</div>
                </div>
                <div class="logo-box">
                    <img src="{{ asset('images/logo1.png') }}" class="logo" alt="Logo 1">
                    <div class="logo-title">مركز معلومات شبكات المرافق بقنا</div>
                </div>
            </div>

            <!-- جدول بيانات العميل -->
            <table>
                <tr><td>اسم العميل</td><td>{{ $data->client_name }}</td></tr>
                <tr><td>الرقم القومي</td><td>{{ $data->national_id }}</td></tr>
                <tr><td>المركز</td><td>{{ $data->center_name }}</td></tr>
                <tr><td>رقم المعاملة</td><td>{{ $data->transaction_number }}</td></tr>
                <tr><td>الغرض</td><td>{{ $data->purpose }}</td></tr>
                <tr><td>الإحداثي</td><td>{{ $data->coordinates }}</td></tr>
            </table>

            <!-- جدول التتبع -->
            <h5>حالة التتبع</h5>
@if(!empty($trackingStatus) && count($trackingStatus) > 0)
    <h5>حالة التتبع</h5>
    <table border="1" cellspacing="0" cellpadding="10" style="border-collapse: collapse; width: 100%; text-align: center; font-size: 14px;">
        <tr>
            <th>التاريخ</th>
            <th>الوصف</th>
        </tr>
        @foreach($trackingStatus as $date => $status)
            @if(!empty($date) || !empty($status))
                <tr>
                    <td>{{ $date }}</td>
                    <td>{{ $status }}</td>
                </tr>
            @endif
        @endforeach
    </table>
@endif
        </div>

        <!-- العمود الأيسر -->
        <div class="left-columns">
            <div class="certificate-title">📄 شهادة تتبع زمني لمنشأ</div>
            <div class="photos-container">
                @foreach($trackingStatus as $date => $status)
                    @if(!empty($date) && !empty($status))
                        <div class="photo-box" ondrop="drop(event, this)" ondragover="allowDrop(event)">
                            <div class="photo-label">صورة بتاريخ {{ $date }}</div>
                            📷 اسحب الصورة هنا
                        </div>
                    @endif
                @endforeach
            </div>
        </div>
    </div>

    <div class="footer-text">
        تم الإرشاد عن الموقع بمعرفة مقدم الطلب وذلك دون أدنى مسؤولية على مركز معلومات شبكات المرافق بقنا - لا يعتد بهذا البيان كمستند ملكية - لا يستخدم هذا البيان إلا في الغرض المحرر من أجله.
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        function printCertificate() {
            document.getElementById('printBtn').style.display = 'none';
            document.getElementById('saveBtn').style.display = 'none';
            window.print();
            setTimeout(() => {
                document.getElementById('printBtn').style.display = 'block';
                document.getElementById('saveBtn').style.display = 'block';
            }, 1000);
        }

        function saveCertificate() {
            let container = document.querySelector('.container');
            html2canvas(container, { scale: 2 }).then(canvas => {
                let link = document.createElement("a");
                link.download = "certificate.png";
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        function allowDrop(ev) { ev.preventDefault(); }
        function drop(ev, element) {
            ev.preventDefault();
            const file = ev.dataTransfer.files[0];
            if (file && file.type.startsWith("image/")) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    element.innerHTML = '<div class="photo-label">' + element.querySelector(".photo-label").innerText + '</div><img src="' + e.target.result + '" alt="صورة">';
                }
                reader.readAsDataURL(file);
            } else {
                alert("يرجى سحب صورة فقط");
            }
        }
    </script>
</body>
</html>
